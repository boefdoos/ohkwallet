// === FIXED ADMIN LOGIN FLOW ===

// Global variables (add these at the top with other globals)
let isAdminLoginInProgress = false;
let shouldShowAdminLogin = false;

// Fixed admin logout function
function adminLogout() {
    shouldShowAdminLogin = true; // Flag to show admin login after logout
    currentAdminData = null;
    auth.signOut();
}

// Improved auth state listener
auth.onAuthStateChanged(async (user) => {
    // Skip processing if admin login is in progress via form
    if (isAdminLoginInProgress) {
        console.log('‚è≥ Skipping auth state change - admin login in progress');
        return;
    }
    
    if (user) {
        console.log('üî• Auth state changed: User logged in:', user.email);
        
        try {
            // Check for pending admin status first
            await checkAndActivatePendingAdmin(user);
            
            const adminSnapshot = await database.ref(`admins/${user.uid}`).once('value');
            if (adminSnapshot.exists()) {
                const adminData = adminSnapshot.val();
                console.log('‚úÖ Admin state restored for:', user.email);
                showContainer('admin');
                await initializeAdminPanel(adminData);
                shouldShowAdminLogin = false; // Reset flag
            } else {
                // User is logged in but not an admin - sign them out
                console.log('‚ùå User has no admin rights, signing out');
                await auth.signOut();
            }
        } catch (error) {
            console.error('‚ùå Error in auth state change:', error);
            await auth.signOut();
        }
    } else {
        console.log('üîì Auth state changed: User logged out');
        currentAdminData = null;
        
        // Show appropriate login screen based on context
        if (shouldShowAdminLogin) {
            showContainer('auth');
            showAdminLogin(); // Go directly to admin login
        } else {
            showContainer('auth');
            showUserAccess(); // Default user access
        }
        
        shouldShowAdminLogin = false; // Reset flag
    }
});

// Fixed admin login form handler
const loginForm = document.getElementById('loginForm');
if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showAlert(document.getElementById('loginAlert'), 'Vul alle velden in');
            return;
        }
        
        // Set flag to prevent auth listener interference
        isAdminLoginInProgress = true;
        showLoading('Inloggen als beheerder...');
        
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Check for pending admin status first
            await checkAndActivatePendingAdmin(user);
            
            // Hardcoded Super Admin Check
            const superAdminEmails = [
                'admin@ohk.be', 
                'superadmin@ohk.be', 
                'administrator@ohk.be',
                'beheerder@ohk.be'
            ];
            
            if (superAdminEmails.includes(email.toLowerCase())) {
                const superAdminData = {
                    level: 'super',
                    email: user.email,
                    createdAt: new Date().toISOString(),
                    isHardcodedAdmin: true
                };
                
                await database.ref(`admins/${user.uid}`).set(superAdminData);
                
                hideLoading();
                isAdminLoginInProgress = false; // Reset flag
                showContainer('admin');
                await initializeAdminPanel(superAdminData);
                return;
            }
            
            // Check admin status
            const adminSnapshot = await database.ref(`admins/${user.uid}`).once('value');
            
            if (!adminSnapshot.exists()) {
                // Auto-create admin if none exist
                const adminsSnapshot = await database.ref('admins').once('value');
                
                if (!adminsSnapshot.exists()) {
                    const adminData = {
                        level: 'super',
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        isFirstAdmin: true
                    };
                    
                    await database.ref(`admins/${user.uid}`).set(adminData);
                    
                    hideLoading();
                    isAdminLoginInProgress = false; // Reset flag
                    showContainer('admin');
                    await initializeAdminPanel(adminData);
                    return;
                } else {
                    throw new Error('Geen beheerder rechten voor dit account');
                }
            }
            
            const adminData = adminSnapshot.val();
            hideLoading();
            isAdminLoginInProgress = false; // Reset flag
            showContainer('admin');
            await initializeAdminPanel(adminData);
            
        } catch (error) {
            console.error('Admin login error:', error);
            hideLoading();
            isAdminLoginInProgress = false; // Reset flag
            
            // Sign out on error to clean up auth state
            try {
                await auth.signOut();
            } catch (signOutError) {
                console.error('Error signing out:', signOutError);
            }
            
            let errorMessage = 'Inloggen mislukt: ';
            if (error.code === 'auth/user-not-found') {
                errorMessage += 'Gebruiker niet gevonden';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage += 'Verkeerd wachtwoord';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage += 'Ongeldig e-mailadres';
            } else {
                errorMessage += error.message;
            }
            
            showAlert(document.getElementById('loginAlert'), errorMessage);
        }
    });
}

// Update the navigation functions to set the flag correctly
function showAdminLogin() {
    document.getElementById('userAccessForm').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
    document.getElementById('authFooter').style.display = 'none';
    shouldShowAdminLogin = true; // Set flag when showing admin login
}

function showUserAccess() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.add('hidden');
    document.getElementById('userAccessForm').classList.remove('hidden');
    document.getElementById('authFooter').style.display = 'block';
    shouldShowAdminLogin = false; // Reset flag when showing user access
}

// Fixed back to user access button
const backToUserBtn = document.getElementById('backToUserAccessBtn');
if (backToUserBtn) {
    backToUserBtn.addEventListener('click', function() {
        shouldShowAdminLogin = false; // Reset flag
        showUserAccess();
    });
}

// Also update the other back button
const backToUserFromRegisterBtn = document.getElementById('backToUserAccessFromRegisterBtn');
if (backToUserFromRegisterBtn) {
    backToUserFromRegisterBtn.addEventListener('click', function() {
        shouldShowAdminLogin = false; // Reset flag
        showUserAccess();
    });
}
