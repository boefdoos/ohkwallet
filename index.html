<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <meta name="description" content="Ademruimte - Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ademruimte - Hyperventilatie Helper</title>
    
    <!-- Preload kritieke resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://unpkg.com">

<style>
    /* CSS Custom Properties voor consistentie */
    :root {
        --primary-gradient: linear-gradient(135deg, #06b6d4 0%, #10b981 50%, #3b82f6 100%);
        --card-background: rgba(255, 255, 255, 0.95);
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --border-radius: 1rem;
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --transition-base: all 0.3s ease;
        --touch-target: 44px;
    }

    /* Reset en basis styling */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
    }

    /* Header */
    header {
        background: linear-gradient(135deg, #06b6d4, #10b981);
        color: white;
        padding: clamp(1rem, 3vw, 2rem);
        text-align: center;
        position: relative;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
    }

    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
    }

    .logo-svg {
        height: clamp(100px, 12vw, 160px);
        width: auto;
        filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
    }

    header h1 {
        font-size: clamp(1.2rem, 4vw, 2rem);
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        letter-spacing: -0.02em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
        font-size: clamp(0.7rem, 2vw, 0.9rem);
        opacity: 0.95;
        margin: 0;
    }

    .user-info {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        font-size: 0.75rem;
        color: rgba(255,255,255,0.9);
        max-width: 120px;
        word-break: break-word;
        text-align: right;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        z-index: 2;
    }

    /* Navigation */
    .nav-tabs {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        padding: 0.75rem 0.5rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        box-shadow: var(--shadow-sm);
        scrollbar-width: none;
        -ms-overflow-style: none;
        display: flex;
        gap: 0.5rem;
    }

    .nav-tabs::-webkit-scrollbar {
        display: none;
    }

    .nav-tabs button {
        background: none;
        border: none;
        padding: 0.875rem 1rem;
        border-radius: 1rem;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: var(--transition-base);
        white-space: nowrap;
        min-height: var(--touch-target);
        min-width: 44px;
        touch-action: manipulation;
        color: var(--text-light);
        position: relative;
        outline: none;
        font-family: inherit;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
    }

    .nav-tabs button:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    .nav-tabs button.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
        font-weight: 600;
    }

    .nav-tabs button:hover:not(.active) {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        transform: translateY(-1px);
    }

    /* Container */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: clamp(1rem, 3vw, 2rem);
        min-height: calc(100vh - 120px);
    }

    /* Cards */
    .card {
        background: var(--card-background);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius);
        padding: clamp(1rem, 3vw, 2rem);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition-base);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
        font-size: clamp(1.25rem, 4vw, 1.75rem);
        font-weight: 700;
        background: linear-gradient(135deg, #06b6d4, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Buttons */
    .btn {
        padding: 1rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: var(--transition-base);
        text-align: center;
        display: inline-block;
        text-decoration: none;
        min-height: var(--touch-target);
        touch-action: manipulation;
        user-select: none;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        outline: none;
        font-family: inherit;
    }

    .btn:focus-visible {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), var(--shadow-sm);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-green {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-red {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-cyan {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    .btn-orange {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .btn-purple {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
    }

    /* Grid */
    .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
    }

    .grid .card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
        border-radius: 1.2rem;
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .grid .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .grid .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 1.2rem 1.2rem 0 0;
    }

    .grid .card h3 {
        font-size: 1.375rem;
        margin-bottom: 1rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .grid .card p {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }

    /* Forms */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        min-height: var(--touch-target);
        font-family: inherit;
        transition: border-color 0.2s ease;
        background-color: #ffffff;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    /* Google button */
    .google-btn {
        width: 100%;
        padding: 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        color: #374151;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        min-height: var(--touch-target);
    }

    .google-btn:hover:not(:disabled) {
        background: #f9fafb;
        border-color: #9ca3af;
    }

    .google-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Alerts */
    .alert {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        border: 1px solid;
        box-shadow: var(--shadow-sm);
    }

    .alert-info {
        background: rgba(219, 234, 254, 0.95);
        border-color: #3b82f6;
        color: #1e40af;
    }

    .alert-success {
        background: rgba(209, 250, 229, 0.95);
        border-color: #10b981;
        color: #065f46;
    }

    .alert-warning {
        background: rgba(254, 243, 199, 0.95);
        border-color: #f59e0b;
        color: #92400e;
    }

    .alert-error {
        background: rgba(254, 226, 226, 0.95);
        border-color: #ef4444;
        color: #991b1b;
    }

    /* User message notifications */
    .user-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        max-width: 90vw;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(15px);
        animation: slideInDown 0.3s ease-out;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Modals */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        padding: 1rem;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        max-width: 400px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
        min-width: 40px;
        min-height: 40px;
        border-radius: 50%;
        transition: var(--transition-base);
    }

    .close-btn:hover {
        background: rgba(0,0,0,0.1);
        color: var(--text-dark);
    }

    /* Divider */
    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e5e7eb;
        z-index: 1;
    }

    .divider span {
        background: white;
        padding: 0 1rem;
        position: relative;
        z-index: 2;
    }

    /* Loading spinner */
    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Status indicators */
    .status-connected {
        background: #059669 !important;
        opacity: 0.8 !important;
    }

    .status-disconnected {
        background: #f59e0b !important;
        opacity: 0.6 !important;
    }

    .status-error {
        background: #ef4444 !important;
        opacity: 0.7 !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }

    /* Utility classes */
    .hidden {
        display: none !important;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .button-group .btn {
        flex: 1;
        min-width: 120px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .modal-content {
            margin: 1rem;
            padding: 1rem;
        }
        
        .btn {
            padding: 1rem;
            font-size: 0.9rem;
        }

        .nav-tabs {
            padding: 0.5rem 0.25rem;
            gap: 0.25rem;
        }

        .nav-tabs button {
            padding: 0.75rem 0.875rem;
            font-size: 0.75rem;
            min-width: 40px;
            border-radius: 0.875rem;
        }

        .user-info {
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.7rem;
            max-width: 100px;
            padding: 0.375rem 0.5rem;
        }

        /* Prevent zoom on input focus for iOS */
        .form-input, .form-select, .form-textarea {
            font-size: 16px;
        }
    }

    @media (max-width: 480px) {
        .nav-tabs button {
            font-size: 0.7rem;
            padding: 0.625rem 0.75rem;
        }

        .user-info {
            font-size: 0.65rem;
            max-width: 90px;
            padding: 0.25rem 0.375rem;
        }
    }
</style>
</head>

<body>
    <header role="banner">
        <div class="user-info" id="user-info" aria-live="polite">
            <div class="spinner" id="auth-loading" aria-label="Bezig met inloggen..."></div>
        </div>
        
        <!-- Ademruimte Logo -->
        <div class="logo-container">
            <svg viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
              <defs>
                <radialGradient id="breathingGradient" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" style="stop-color:#FFE0E6;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#FF7F7F;stop-opacity:0.6"/>
                  <stop offset="100%" style="stop-color:#26A69A;stop-opacity:0.4"/>
                </radialGradient>
                
                <linearGradient id="textGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#FFFFFF"/>
                  <stop offset="50%" style="stop-color:#FFE0E6"/>
                  <stop offset="100%" style="stop-color:#FFFFFF"/>
                </linearGradient>
                
                <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#26A69A;stop-opacity:0.9"/>
                  <stop offset="50%" style="stop-color:#4DB6AC;stop-opacity:0.5"/>
                  <stop offset="100%" style="stop-color:#FF7F7F;stop-opacity:0.3"/>
                </linearGradient>
              </defs>
              
              <circle cx="60" cy="60" r="30" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" opacity="0.7">
                <animate attributeName="r" values="30;33;30" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.5;0.8;0.5" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="20" fill="url(#breathingGradient)" opacity="0.8">
                <animate attributeName="r" values="20;22;20" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.7;0.9;0.7" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <circle cx="60" cy="60" r="4" fill="#FF6B6B" opacity="1">
                <animate attributeName="r" values="4;6;4" dur="8s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.9;1;0.9" dur="8s" repeatCount="indefinite"/>
              </circle>
              
              <text x="140" y="45" font-family="Arial, sans-serif" font-size="28" font-weight="300" fill="url(#textGradient)">
                ademruimte
              </text>
              
              <text x="140" y="72" font-family="Arial, sans-serif" font-size="13" fill="rgba(255,255,255,0.9)" opacity="0.95">
                your safe breathing space
              </text>
            </svg>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="login-screen" role="main">
        <div style="max-width: 400px; margin: 2rem auto; padding: 0 1rem;">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">
                    Welkom bij Ademruimte
                </h2>
                
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-light);">
                    Log in om je vooruitgang op te slaan en te synchroniseren tussen al je apparaten.
                </p>

                <!-- Google Login -->
                <button id="google-login-btn" class="google-btn" aria-label="Inloggen met Google account">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Doorgaan met Google</span>
                </button>

                <div class="divider">
                    <span>of</span>
                </div>

                <!-- Email/Password Login -->
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email" class="form-label">E-mail:</label>
                        <input type="email" 
                               id="login-email" 
                               class="form-input" 
                               placeholder="jouw@email.com" 
                               required 
                               autocomplete="email">
                    </div>

                    <div class="form-group">
                        <label for="login-password" class="form-label">Wachtwoord:</label>
                        <input type="password" 
                               id="login-password" 
                               class="form-input" 
                               placeholder="Wachtwoord" 
                               required 
                               autocomplete="current-password">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Inloggen
                    </button>
                </form>

                <div style="text-align: center;">
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 1rem;">
                        Nog geen account?
                    </p>
                    <button id="show-register-btn" class="btn btn-green" style="width: 100%;">
                        Account Aanmaken
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Account Aanmaken</h3>
                <button class="close-btn" aria-label="Sluit registratie venster">&times;</button>
            </div>
            
            <form id="register-form">
                <div class="form-group">
                    <label for="register-name" class="form-label">Naam:</label>
                    <input type="text" 
                           id="register-name" 
                           class="form-input" 
                           placeholder="Jouw naam" 
                           required>
                </div>

                <div class="form-group">
                    <label for="register-email" class="form-label">E-mail:</label>
                    <input type="email" 
                           id="register-email" 
                           class="form-input" 
                           placeholder="jouw@email.com" 
                           required>
                </div>

                <div class="form-group">
                    <label for="register-password" class="form-label">Wachtwoord:</label>
                    <input type="password" 
                           id="register-password" 
                           class="form-input" 
                           placeholder="Minimaal 6 karakters" 
                           required 
                           minlength="6">
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-green">
                        Account Aanmaken
                    </button>
                    <button type="button" class="btn" id="cancel-register-btn">
                        Annuleren
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <nav class="nav-tabs" role="navigation">
            <button class="tab-btn active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis</button>
            <button class="tab-btn" data-tab="buteyko">🌬️ Buteyko</button>
            <button class="tab-btn" data-tab="ritueel">🕐 Ritueel</button>
            <button class="tab-btn" data-tab="gapen">🥱 Gapen</button>
        </nav>

        <main class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="card" style="text-align: center; padding: 2rem; margin-bottom: 2rem;">
                    <h2 id="dashboard-greeting">
                        Welkom bij Ademruimte
                    </h2>
                    <p style="color: var(--text-light); font-size: 1rem; margin-top: 0.5rem;">
                        Je persoonlijke ruimte voor ademhalingsoefeningen en hyperventilatie begeleiding.
                    </p>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3>🚨 Crisis Hulp</h3>
                        <p>Voor wanneer je luchthonger voelt opkomen</p>
                        <button class="btn btn-red" onclick="showTab('crisis')">Open Crisis Hulp</button>
                    </div>

                    <div class="card">
                        <h3>🌬️ Buteyko Ademhaling</h3>
                        <p>CO2 tolerantie training</p>
                        <button class="btn btn-cyan" onclick="showTab('buteyko')">Start Buteyko</button>
                    </div>

                    <div class="card">
                        <h3>🕐 Afkoel Ritueel</h3>
                        <p>Na intensief denkwerk</p>
                        <button class="btn btn-green" onclick="showTab('ritueel')">Start Ritueel</button>
                    </div>

                    <div class="card">
                        <h3>🥱 Gaap Preventie</h3>
                        <p>Technieken voor gaapaanvallen</p>
                        <button class="btn btn-orange" onclick="showTab('gapen')">Bekijk Technieken</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Tip van de dag:</strong> 
                    <span id="daily-tip">Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.</span>
                    <button id="tip-refresh-btn" 
                            style="background: none; border: none; color: #0891b2; cursor: pointer; margin-left: 0.5rem; font-weight: 600;">🔄</button>
                </div>

                <div class="card">
                    <h3>👤 Account</h3>
                    <div id="account-info" style="margin-bottom: 1rem;">
                        <!-- Account info wordt hier ingevuld -->
                    </div>
                    <button class="btn btn-red" onclick="performLogout()">
                        🚪 Uitloggen
                    </button>
                </div>
            </div>

            <!-- Crisis Tab -->
            <div id="crisis" class="tab-content hidden">
                <div class="card">
                    <h2>🚨 Crisis Hulp - Luchthonger</h2>
                    <p>Voor wanneer je dat benauwde gevoel voelt opkomen</p>
                </div>

                <div class="card">
                    <h3>1. Paradoxale Ademhaling</h3>
                    <p>Start met bewust zeer kleine, korte ademhalingen. Na 3-4 van deze mini-ademhalingen, probeer een iets langere uitademing.</p>
                </div>

                <div class="card">
                    <h3>2. Purse-lip Ademhaling</h3>
                    <p>Tuut je lippen bij het uitademen om lichte weerstand te creëren. Dit helpt bij luchthonger en stabiliseert CO2-niveaus.</p>
                </div>

                <div class="card">
                    <h3>3. IJswater Techniek</h3>
                    <p>Breng iets kouds tegen je gezicht (vooral rond wangen en ogen) om de duikreflex te activeren.</p>
                </div>

                <div class="card">
                    <h3>4. Herframing</h3>
                    <p>"Dit is geen echt zuurstoftekort, dit is een sensatie die voorbij zal gaan. Mijn lichaam krijgt genoeg zuurstof."</p>
                </div>

                <div class="card">
                    <h3>5-4-3-2-1 Grounding</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li>✓ 5 dingen die je ZIET</li>
                        <li>✓ 4 dingen die je VOELT</li>
                        <li>✓ 3 dingen die je HOORT</li>
                        <li>✓ 2 dingen die je RUIKT</li>
                        <li>✓ 1 ding dat je PROEFT</li>
                    </ul>
                </div>
            </div>

            <!-- Buteyko Tab -->
            <div id="buteyko" class="tab-content hidden">
                <div class="card">
                    <h2>🌬️ Buteyko Ademhaling</h2>
                    <p>Verbeter je CO2 tolerantie en verminder hyperventilatie neiging</p>
                    
                    <div class="alert alert-info">
                        <strong>💡 Hoe het werkt:</strong> Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus, wat hyperventilatie-episodes kan verminderen.
                    </div>

                    <div style="text-align: center; margin: 2rem 0;">
                        <div id="breath-display" style="font-size: 2rem; font-weight: bold; padding: 2rem; border-radius: 1rem; background: #f8fafc; color: var(--text-dark); margin-bottom: 1rem;">
                            Klik op start om te beginnen
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <div style="background: #e5e7eb; height: 0.75rem; border-radius: 0.375rem; overflow: hidden;">
                                <div id="breath-progress" style="height: 100%; background: #10b981; border-radius: 0.375rem; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <div id="breath-cycle-counter" style="font-size: 1.125rem; color: var(--text-light); margin-bottom: 1rem;">
                            Cyclus: 1/10
                        </div>
                        
                        <div class="button-group">
                            <button id="breath-btn" class="btn btn-cyan" onclick="toggleBreathExercise()">
                                ▶️ Start Buteyko
                            </button>
                            <button class="btn btn-orange" onclick="resetBreathExercise()">
                                🔄 Reset
                            </button>
                        </div>
                    </div>

                    <div id="breath-complete" class="alert alert-success hidden">
                        <strong>✅ Buteyko Sessie Voltooid!</strong><br>
                        Geweldig! Je hebt 10 ademhalingscycli succesvol afgerond.
                    </div>
                </div>
            </div>

            <!-- Ritueel Tab -->
            <div id="ritueel" class="tab-content hidden">
                <div class="card">
                    <h2>🕐 Afkoel Ritueel</h2>
                    <p>Voor na periodes van intensief denkwerk (5-10 minuten)</p>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <h3 id="ritual-title">Stap 1: Fysieke Mini-Reset</h3>
                        <div style="font-size: 2.5rem; font-weight: bold; margin: 1.5rem 0; font-family: 'Courier New', monospace;" id="timer-display">2:00</div>
                        
                        <div id="ritual-instructions">
                            <ul style="list-style: none; padding-left: 0; text-align: left; max-width: 400px; margin: 0 auto;">
                                <li style="padding: 0.5rem 0;">✓ Sta op en strek je volledig uit</li>
                                <li style="padding: 0.5rem 0;">✓ Schud je armen en benen los</li>
                                <li style="padding: 0.5rem 0;">✓ Rol je schouders 5x naar achteren</li>
                                <li style="padding: 0.5rem 0;">✓ Maak kleine cirkels met je hoofd (5x elke richting)</li>
                            </ul>
                        </div>

                        <div class="button-group">
                            <button id="timer-btn" class="btn btn-green" onclick="startTimer()">▶️ Start Timer</button>
                            <button class="btn btn-primary" onclick="nextRitualStep()" id="next-btn" style="display: none;">Volgende Stap</button>
                            <button class="btn btn-cyan" onclick="skipToNextStep()">⏭️ Overslaan</button>
                            <button class="btn btn-orange" onclick="resetRitual()">🔄 Reset</button>
                        </div>

                        <div style="background: #e5e7eb; height: 0.75rem; border-radius: 0.375rem; overflow: hidden; margin: 1rem 0;">
                            <div id="ritual-progress" style="height: 100%; background: #10b981; border-radius: 0.375rem; width: 20%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    <div id="ritual-complete" class="alert alert-success hidden">
                        <strong>✅ Afkoel Ritueel Voltooid!</strong><br>
                        Fantastisch! Je hebt alle 5 stappen van het afkoel ritueel doorlopen.
                    </div>
                </div>
            </div>

            <!-- Gapen Tab -->
            <div id="gapen" class="tab-content hidden">
                <div class="card">
                    <h2>🥱 Gaap Preventie Technieken</h2>
                    <p>Voor wanneer je die vervelende gaapaanvallen voelt opkomen</p>
                </div>

                <div class="card">
                    <h3>Lipremming-techniek</h3>
                    <p>Druk je lippen zachtjes op elkaar wanneer je een gaapneiging voelt. Laat de lucht langzaam door je neus in en uit gaan.</p>
                </div>

                <div class="card">
                    <h3>Mini-ademhalingen</h3>
                    <p>Neem bewust 3-4 zeer kleine, ondiepe ademhalingen door je neus. Hiermee voorkom je de grote 'zucht-ademhaling'.</p>
                </div>

                <div class="card">
                    <h3>Tongpositie veranderen</h3>
                    <p>Plaats je tongpunt tegen je gehemelte (achter je voortanden). Dit vermindert de neiging tot gapen.</p>
                </div>

                <div class="card">
                    <h3>Water drinken</h3>
                    <p>Neem kleine slokjes water wanneer je merkt dat je begint te gapen. Dit doorbreekt het ademhalingspatroon.</p>
                </div>

                <div class="alert alert-info">
                    <strong>💡 Belangrijk om te onthouden:</strong> Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Ze geven je de kans om preventief in te grijpen voordat een volledige hyperventilatie-episode begint.
                </div>
            </div>
        </main>
    </div>

    <footer style="text-align: center; padding: 2rem 1rem; color: var(--text-light); font-size: 0.8rem;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <p style="margin: 0;">📞 In noodgevallen: contacteer altijd je huisarts of spoeddiensten</p>
            
            <!-- Firebase Status Indicator -->
            <div style="display: flex; align-items: center; gap: 0.375rem;">
                <div id="firebase-status-dot" class="status-disconnected" style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; transition: all 0.3s ease; opacity: 0.6;" title="Firebase verbinding status"></div>
                <span style="font-size: 0.7rem; opacity: 0.7;">Status</span>
            </div>
        </div>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <p style="margin: 0; font-size: 0.75rem; opacity: 0.8; color: rgba(255,255,255,0.9);">
                Ontwikkeld door <strong>Thomas Van Troostenberghe</strong>
            </p>
        </div>
    </footer>

<script type="module">
    // Enable detailed logging
    console.log('🚀 Ademruimte App Starting...');
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBwDkmbKOzZAyIZW7-ud4qYr7xHyILCdzI",
        authDomain: "ademruimte-12c09.firebaseapp.com", 
        projectId: "ademruimte-12c09",
        storageBucket: "ademruimte-12c09.firebasestorage.app",
        messagingSenderId: "744941871331",
        appId: "1:744941871331:web:c3ce24d814fe41314d25d6",
        measurementId: "G-SD2ZEYNMNY"
    };

    // Global variables
    let app, db, auth;
    let currentUser = null;
    let isFirebaseConnected = false;
    let authInitialized = false;
    
    // Exercise variables
    let breathInterval = null;
    let breathPhase = 'rest';
    let breathCycleCount = 1;
    let breathPhaseTime = 0;
    
    let timerInterval = null;
    let currentTime = 0;
    let ritualStep = 0;

    // Tips array
    const tips = [
        "Gaapaanvallen zijn een waarschuwingssignaal, geen bedreiging. Gebruik ze als mogelijkheid om preventief in te grijpen.",
        "Bij luchthonger: probeer paradoxale ademhaling - begin met zeer kleine, korte ademhalingen.",
        "CO2 is niet giftig! Een hoger CO2-niveau in je bloed is juist gezond en kalmerend.",
        "Buteyko ademhaling helpt je lichaam wennen aan hogere CO2 niveaus.",
        "Een koude kompres op je gezicht activeert de duikreflex en kalmeert het zenuwstelsel.",
        "Grounding technieken zoals 5-4-3-2-1 helpen je geest terug naar het hier en nu te brengen.",
        "Zachte ademhaling is effectiever dan diepe ademhaling bij hyperventilatie.",
        "Regelmatige oefening van ademhalingstechnieken vermindert de kans op episodes."
    ];

    // Ritual steps data
    const ritualSteps = [
        {
            title: "Stap 1: Fysieke Mini-Reset",
            duration: 120,
            instructions: [
                "Sta op en strek je volledig uit",
                "Schud je armen en benen los", 
                "Rol je schouders 5x naar achteren",
                "Maak kleine cirkels met je hoofd (5x elke richting)"
            ]
        },
        {
            title: "Stap 2: Ademhaling Reset",
            duration: 90,
            instructions: [
                "Ga comfortabel zitten of staan",
                "Adem 5x heel diep in door je neus",
                "Adem langzaam uit door je mond",
                "Let op de vertraging tussen gedachte en lichaam"
            ]
        },
        {
            title: "Stap 3: Mentale Overgang",
            duration: 120,
            instructions: [
                "Zeg hardop: 'Ik ben klaar met intensief denken'",
                "Denk aan 3 dingen waar je dankbaar voor bent",
                "Visualiseer je volgende activiteit",
                "Geef jezelf toestemming om te ontspannen"
            ]
        },
        {
            title: "Stap 4: Zintuiglijke Reset",
            duration: 90,
            instructions: [
                "Kijk bewust rond - wat zie je?",
                "Luister naar geluiden om je heen",
                "Voel de temperatuur op je huid",
                "Ruik bewust de lucht om je heen"
            ]
        },
        {
            title: "Stap 5: Intentie Zetten",
            duration: 60,
            instructions: [
                "Besluit bewust hoe je je volgende tijd wilt besteden",
                "Zeg tegen jezelf: 'Ik ga nu over naar [activiteit]'",
                "Neem één bewuste stap in die richting",
                "Feliciteer jezelf - je hebt een goede overgang gemaakt"
            ]
        }
    ];

    // Utility functions
    function log(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString('nl-NL');
        const emoji = {
            'INFO': 'ℹ️',
            'SUCCESS': '✅', 
            'WARNING': '⚠️',
            'ERROR': '❌'
        };
        console.log(`${emoji[level] || '📝'} [${timestamp}] ${message}`, data || '');
    }

    function showUserMessage(message, type = 'info') {
        // Remove existing message
        const existing = document.querySelector('.user-message');
        if (existing) existing.remove();
        
        const messageEl = document.createElement('div');
        messageEl.className = `user-message alert-${type}`;
        messageEl.textContent = message;
        
        document.body.appendChild(messageEl);
        
        // Auto-remove
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.remove();
            }
        }, type === 'error' ? 8000 : 5000);
    }

    function updateConnectionStatus(connected) {
        isFirebaseConnected = connected;
        const statusDot = document.getElementById('firebase-status-dot');
        if (statusDot) {
            if (connected) {
                statusDot.className = 'status-connected';
                statusDot.title = 'Firebase: Verbonden';
            } else {
                statusDot.className = 'status-disconnected';
                statusDot.title = 'Firebase: Niet verbonden';
            }
        }
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        const accountInfo = document.getElementById('account-info');
        const authLoading = document.getElementById('auth-loading');
        
        // Hide loading spinner
        if (authLoading) {
            authLoading.style.display = 'none';
        }

        if (currentUser && userInfo) {
            const displayName = currentUser.displayName || currentUser.email;
            const shortName = displayName.length > 15 ? displayName.substring(0, 13) + '...' : displayName;
            userInfo.innerHTML = shortName;
        } else if (userInfo) {
            userInfo.innerHTML = '';
        }

        if (currentUser && accountInfo) {
            accountInfo.innerHTML = 
                '<p style="color: var(--text-light); font-size: 0.9rem;">' +
                '<strong>Ingelogd als:</strong><br>' + 
                (currentUser.displayName || currentUser.email) + 
                '</p>';
        } else if (accountInfo) {
            accountInfo.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">Niet ingelogd</p>';
        }
        
        updateDashboardGreeting();
    }

    function updateDashboardGreeting() {
        const greetingElement = document.getElementById('dashboard-greeting');
        if (greetingElement && currentUser) {
            const firstName = getFirstName();
            const timeOfDay = getTimeOfDay();
            greetingElement.textContent = `${timeOfDay}, ${firstName}!`;
        } else if (greetingElement) {
            greetingElement.textContent = `Welkom bij Ademruimte`;
        }
    }

    function getFirstName() {
        if (!currentUser) return 'Gebruiker';
        
        const displayName = currentUser.displayName;
        if (displayName) {
            return displayName.split(' ')[0];
        }
        
        const email = currentUser.email;
        if (email) {
            const localPart = email.split('@')[0];
            return localPart.charAt(0).toUpperCase() + localPart.slice(1);
        }
        
        return 'Gebruiker';
    }

    function getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour < 12) return 'Goedemorgen';
        if (hour < 18) return 'Goedemiddag';
        return 'Goedenavond';
    }

    function showLoginScreen() {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
        log('INFO', 'Switched to login screen');
    }

    function showMainApp() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        log('INFO', 'Switched to main app');
    }

    // Firebase initialization with detailed logging
    async function initializeFirebase() {
        if (authInitialized) {
            console.log('✅ Firebase already initialized');
            return true;
        }
        
        try {
            console.log('🔥 Starting Firebase initialization...');
            console.log('📊 Config check:', {
                apiKey: firebaseConfig.apiKey ? 'Present' : 'Missing',
                authDomain: firebaseConfig.authDomain,
                projectId: firebaseConfig.projectId
            });
            
            // Test if we can access Firebase modules
            console.log('📦 Loading Firebase modules...');
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
            const { getFirestore } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js");
            const { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            console.log('✅ Firebase modules loaded successfully');

            // Initialize Firebase
            console.log('🔧 Initializing Firebase app...');
            app = initializeApp(firebaseConfig);
            console.log('✅ Firebase app initialized');
            
            db = getFirestore(app);
            console.log('✅ Firestore initialized');
            
            auth = getAuth(app);
            console.log('✅ Auth initialized');

            // Set up auth state observer with detailed logging
            console.log('👁️ Setting up auth state observer...');
            onAuthStateChanged(auth, (user) => {
                console.log('🔔 Auth state changed:', user ? `User: ${user.email}` : 'No user');
                currentUser = user;
                updateUserInfo();
                
                if (user) {
                    console.log('✅ User authenticated, showing main app');
                    showMainApp();
                } else {
                    console.log('❌ No user, showing login screen');
                    showLoginScreen();
                }
            }, (error) => {
                console.error('❌ Auth state observer error:', error);
                updateUserInfo(); // Hide spinner
                showUserMessage('Authenticatie fout: ' + error.message, 'error');
                showLoginScreen();
            });

            updateConnectionStatus(true);
            authInitialized = true;
            console.log('🎉 Firebase initialization completed successfully');
            return true;

        } catch (error) {
            console.error('💥 Firebase initialization failed:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                code: error.code,
                stack: error.stack
            });
            
            updateConnectionStatus(false);
            authInitialized = false;
            
            showUserMessage('Firebase kon niet worden geïnitialiseerd. Details in console.', 'error');
            showLoginScreen();
            return false;
        }
    }

    // Authentication functions with enhanced debugging
    window.signInWithGoogle = async function() {
        console.log('🔵 Google sign-in button clicked');
        const googleBtn = document.getElementById('google-login-btn');
        const originalText = googleBtn.textContent;
        googleBtn.textContent = 'Bezig...';
        googleBtn.disabled = true;

        try {
            if (!authInitialized || !auth) {
                console.log('⚠️ Firebase not initialized, initializing now...');
                const initialized = await initializeFirebase();
                if (!initialized) {
                    throw new Error('Firebase initialization failed');
                }
            }

            console.log('🔵 Starting Google popup sign-in...');
            const { GoogleAuthProvider, signInWithPopup } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            console.log('🔵 Opening popup...');
            const result = await signInWithPopup(auth, provider);
            console.log('✅ Google sign-in successful:', result.user.email);
            
        } catch (error) {
            console.error('❌ Google sign-in failed:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                code: error.code
            });
            
            let message = 'Google inloggen mislukt';
            if (error.code === 'auth/popup-blocked') {
                message = 'Login werd geblokkeerd. Controleer popup instellingen.';
            } else if (error.code === 'auth/cancelled-popup-request') {
                message = 'Login geannuleerd door gebruiker.';
            } else if (error.code === 'auth/popup-closed-by-user') {
                message = 'Login popup gesloten.';
            } else if (error.message.includes('Firebase initialization failed')) {
                message = 'Firebase kon niet worden geïnitialiseerd. Herlaad de pagina.';
            }
            showUserMessage(message, 'error');
        } finally {
            googleBtn.textContent = originalText;
            googleBtn.disabled = false;
        }
    };

    async function handleLogin(e) {
        e.preventDefault();
        console.log('📧 Email login attempt');
        
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        
        console.log('📧 Email:', email);
        console.log('🔑 Password length:', password.length);
        
        if (!email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }

        if (!authInitialized || !auth) {
            console.log('⚠️ Firebase not initialized for email login');
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase niet beschikbaar. Herlaad de pagina.', 'error');
                return;
            }
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Bezig met inloggen...';
            submitBtn.disabled = true;
            
            console.log('📧 Attempting email sign-in...');
            const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            const result = await signInWithEmailAndPassword(auth, email, password);
            
            console.log('✅ Email sign-in successful:', result.user.email);
            e.target.reset();
            
        } catch (error) {
            console.error('❌ Email sign-in failed:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                code: error.code
            });
            
            let message = 'Inloggen mislukt';
            if (error.code === 'auth/user-not-found') {
                message = 'Geen account gevonden met dit email adres';
            } else if (error.code === 'auth/wrong-password') {
                message = 'Verkeerd wachtwoord';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            } else if (error.code === 'auth/invalid-credential') {
                message = 'Ongeldige inloggegevens';
            } else if (error.code === 'auth/too-many-requests') {
                message = 'Te veel mislukte pogingen. Probeer het later opnieuw.';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    async function handleRegister(e) {
        e.preventDefault();
        console.log('🆕 Registration attempt');
        
        const name = document.getElementById('register-name').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        
        console.log('🆕 Registration data:', { name, email, passwordLength: password.length });
        
        if (!name || !email || !password) {
            showUserMessage('Vul alle velden in', 'warning');
            return;
        }
        
        if (password.length < 6) {
            showUserMessage('Wachtwoord moet minimaal 6 karakters zijn', 'warning');
            return;
        }

        if (!authInitialized || !auth) {
            console.log('⚠️ Firebase not initialized for registration');
            const initialized = await initializeFirebase();
            if (!initialized) {
                showUserMessage('Firebase niet beschikbaar. Herlaad de pagina.', 'error');
                return;
            }
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.textContent = 'Account aanmaken...';
            submitBtn.disabled = true;
            
            console.log('🆕 Creating user account...');
            const { createUserWithEmailAndPassword, updateProfile } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
            
            const result = await createUserWithEmailAndPassword(auth, email, password);
            console.log('✅ User created:', result.user.uid);
            
            console.log('👤 Updating profile...');
            await updateProfile(result.user, { displayName: name });
            console.log('✅ Profile updated');
            
            closeRegisterModal();
            showUserMessage('Account succesvol aangemaakt!', 'success');
            
        } catch (error) {
            console.error('❌ Registration failed:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                code: error.code
            });
            
            let message = 'Account aanmaken mislukt';
            if (error.code === 'auth/email-already-in-use') {
                message = 'Dit email adres is al in gebruik. Probeer in te loggen.';
            } else if (error.code === 'auth/weak-password') {
                message = 'Wachtwoord is te zwak. Gebruik minimaal 6 karakters.';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Ongeldig email adres';
            }
            
            showUserMessage(message, 'error');
            
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    window.performLogout = async function() {
        if (!confirm('Weet je zeker dat je wilt uitloggen?')) {
            return;
        }
        
        try {
            console.log('🚪 Logging out...');
            if (auth && auth.currentUser) {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");
                await signOut(auth);
                console.log('✅ User logged out successfully');
                showUserMessage('Je bent succesvol uitgelogd!', 'success');
            }
        } catch (error) {
            console.error('❌ Logout failed:', error);
            showUserMessage('Uitloggen mislukt: ' + error.message, 'error');
        }
    };

    // Tab management
    window.showTab = function(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        const selectedTab = document.getElementById(tabName);
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }
        
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }
        
        log('INFO', `Switched to tab: ${tabName}`);
    };

    // Modal functions
    window.showRegisterForm = function() {
        document.getElementById('register-modal').classList.add('show');
    };

    function closeRegisterModal() {
        document.getElementById('register-modal').classList.remove('show');
        document.getElementById('register-form').reset();
    }

    // Tip management
    function setRandomTip() {
        const tipElement = document.getElementById('daily-tip');
        if (tipElement) {
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            tipElement.textContent = randomTip;
        }
    }

    window.getNewTip = function() {
        setRandomTip();
        showUserMessage('Nieuwe tip geladen! 💡', 'success');
    };

    // Breathing exercise functions
    window.toggleBreathExercise = function() {
        if (breathInterval) {
            stopBreathExercise();
        } else {
            startBreathExercise();
        }
    };

    window.resetBreathExercise = function() {
        stopBreathExercise();
        breathCycleCount = 1;
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        document.getElementById('breath-cycle-counter').textContent = 'Cyclus: 1/10';
        document.getElementById('breath-complete').classList.add('hidden');
    };

    function startBreathExercise() {
        breathCycleCount = 1;
        breathPhase = 'inhale';
        breathPhaseTime = 0;
        
        document.getElementById('breath-btn').innerHTML = '⏸️ Stop Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-red';
        
        breathInterval = setInterval(() => {
            updateBreathCycle();
        }, 100);
    }

    function stopBreathExercise() {
        if (breathInterval) {
            clearInterval(breathInterval);
            breathInterval = null;
        }
        
        breathPhase = 'rest';
        updateBreathDisplay();
        updateBreathProgress(0);
        
        document.getElementById('breath-btn').innerHTML = '▶️ Start Buteyko';
        document.getElementById('breath-btn').className = 'btn btn-cyan';
    }

    function updateBreathCycle() {
        const inhale = 4;
        const exhale = 6; 
        const hold = 3;
        
        breathPhaseTime += 0.1;
        let progress = 0;
        
        if (breathPhase === 'inhale') {
            progress = (breathPhaseTime / inhale) * 100;
            if (breathPhaseTime >= inhale) {
                breathPhase = 'exhale';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'exhale') {
            progress = (breathPhaseTime / exhale) * 100;
            if (breathPhaseTime >= exhale) {
                breathPhase = 'hold';
                breathPhaseTime = 0;
            }
        } else if (breathPhase === 'hold') {
            progress = (breathPhaseTime / hold) * 100;
            if (breathPhaseTime >= hold) {
                breathPhase = 'inhale';
                breathPhaseTime = 0;
                breathCycleCount++;
                document.getElementById('breath-cycle-counter').textContent = `Cyclus: ${breathCycleCount}/10`;
                
                if (breathCycleCount > 10) {
                    stopBreathExercise();
                    document.getElementById('breath-complete').classList.remove('hidden');
                    log('SUCCESS', 'Buteyko session completed');
                    return;
                }
            }
        }
        
        updateBreathDisplay();
        updateBreathProgress(Math.min(progress, 100));
    }

    function updateBreathDisplay() {
        const display = document.getElementById('breath-display');
        
        switch (breathPhase) {
            case 'inhale':
                display.textContent = '🌬️ Inademen';
                display.style.background = 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
                display.style.color = '#1e40af';
                break;
            case 'exhale':
                display.textContent = '💨 Uitademen';
                display.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                display.style.color = '#065f46';
                break;
            case 'hold':
                display.textContent = '⏸️ Pauze';
                display.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                display.style.color = '#92400e';
                break;
            case 'rest':
            default:
                display.textContent = 'Klik op start om te beginnen';
                display.style.background = '#f8fafc';
                display.style.color = 'var(--text-dark)';
                break;
        }
    }

    function updateBreathProgress(percentage) {
        document.getElementById('breath-progress').style.width = percentage + '%';
    }

    // Timer functions for Ritual
    window.startTimer = function() {
        const timerDisplay = document.getElementById('timer-display');
        const timerBtn = document.getElementById('timer-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerBtn.innerHTML = '▶️ Start Timer';
            timerBtn.className = 'btn btn-green';
            nextBtn.style.display = 'block';
            return;
        }
        
        currentTime = ritualSteps[ritualStep].duration;
        timerBtn.innerHTML = '⏸️ Stop Timer';
        timerBtn.className = 'btn btn-red';
        nextBtn.style.display = 'none';
        
        timerInterval = setInterval(() => {
            currentTime--;
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (currentTime <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.innerHTML = '▶️ Start Timer';
                timerBtn.className = 'btn btn-green';
                nextBtn.style.display = 'block';
                showUserMessage('⏰ Timer afgelopen! Tijd voor de volgende stap.', 'success');
            }
        }, 1000);
    };

    window.nextRitualStep = function() {
        if (ritualStep < ritualSteps.length - 1) {
            ritualStep++;
            updateRitualDisplay();
        } else {
            document.getElementById('ritual-complete').classList.remove('hidden');
            log('SUCCESS', 'Ritual completed');
        }
    };

    window.skipToNextStep = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
            document.getElementById('timer-btn').className = 'btn btn-green';
        }
        nextRitualStep();
    };

    window.resetRitual = function() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        ritualStep = 0;
        updateRitualDisplay();
        document.getElementById('ritual-complete').classList.add('hidden');
        document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
    };

    function updateRitualDisplay() {
        const step = ritualSteps[ritualStep];
        
        document.getElementById('ritual-title').textContent = step.title;
        
        const minutes = Math.floor(step.duration / 60);
        const seconds = step.duration % 60;
        document.getElementById('timer-display').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        currentTime = step.duration;
        
        const instructionsHtml = '<ul style="list-style: none; padding-left: 0; text-align: left; max-width: 400px; margin: 0 auto;">' + 
            step.instructions.map(instruction => `<li style="padding: 0.5rem 0;">✓ ${instruction}</li>`).join('') +
            '</ul>';
        document.getElementById('ritual-instructions').innerHTML = instructionsHtml;
        
        const progress = ((ritualStep + 1) / ritualSteps.length) * 100;
        document.getElementById('ritual-progress').style.width = progress + '%';
        
        document.getElementById('timer-btn').innerHTML = '▶️ Start Timer';
        document.getElementById('timer-btn').className = 'btn btn-green';
        document.getElementById('next-btn').style.display = 'none';
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    // Event listeners setup with detailed logging
    function setupEventListeners() {
        console.log('🔧 Setting up event listeners...');
        
        try {
            // Google login
            const googleBtn = document.getElementById('google-login-btn');
            if (googleBtn) {
                googleBtn.addEventListener('click', signInWithGoogle);
                console.log('✅ Google login button listener attached');
            } else {
                console.error('❌ Google login button not found');
            }
            
            // Login form
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
                console.log('✅ Login form listener attached');
            } else {
                console.error('❌ Login form not found');
            }
            
            // Register modal buttons
            const showRegisterBtn = document.getElementById('show-register-btn');
            if (showRegisterBtn) {
                showRegisterBtn.addEventListener('click', showRegisterForm);
                console.log('✅ Show register button listener attached');
            }
            
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
                console.log('✅ Register form listener attached');
            }
            
            const cancelRegisterBtn = document.getElementById('cancel-register-btn');
            if (cancelRegisterBtn) {
                cancelRegisterBtn.addEventListener('click', closeRegisterModal);
                console.log('✅ Cancel register button listener attached');
            }
            
            // Register modal close button
            const registerCloseBtn = document.querySelector('#register-modal .close-btn');
            if (registerCloseBtn) {
                registerCloseBtn.addEventListener('click', closeRegisterModal);
                console.log('✅ Register close button listener attached');
            }
            
            // Tip refresh
            const tipRefreshBtn = document.getElementById('tip-refresh-btn');
            if (tipRefreshBtn) {
                tipRefreshBtn.addEventListener('click', getNewTip);
                console.log('✅ Tip refresh button listener attached');
            }
            
            // Tab navigation
            const tabButtons = document.querySelectorAll('.tab-btn');
            console.log(`🔧 Found ${tabButtons.length} tab buttons`);
            tabButtons.forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    console.log(`🔄 Tab clicked: ${tab}`);
                    showTab(tab);
                });
                console.log(`✅ Tab button ${index + 1} listener attached`);
            });
            
            // Modal close on background click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
            
            console.log('🎉 All event listeners setup completed successfully');
            
        } catch (error) {
            console.error('❌ Error setting up event listeners:', error);
            throw error; // Re-throw to be caught by main initialization
        }
    }

    // Initialize app with comprehensive debugging
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🎯 DOMContentLoaded fired - starting app initialization');
        console.log('🌐 User agent:', navigator.userAgent);
        console.log('🌐 Online status:', navigator.onLine);
        
        try {
            // Show loading spinner initially
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'inline-block';
                console.log('⏳ Showing auth loading spinner');
            }
            
            // Initialize UI components first
            console.log('🎨 Initializing UI components...');
            updateUserInfo();
            updateConnectionStatus(false);
            setRandomTip();
            updateRitualDisplay();
            
            setupEventListeners();
            console.log('✅ UI components initialized');
            
            // Initialize Firebase immediately
            console.log('🔥 Starting Firebase initialization immediately...');
            const success = await initializeFirebase();
            
            if (!success) {
                console.log('❌ Firebase initialization failed, showing login screen');
                showLoginScreen();
            } else {
                console.log('✅ Firebase initialized successfully');
                // Auth state observer will handle showing the right screen
            }
            
            console.log('🎉 App initialization completed');
            
        } catch (error) {
            console.error('💥 Critical error during app initialization:', error);
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            
            // Hide loading spinner on critical failure
            const authLoading = document.getElementById('auth-loading');
            if (authLoading) {
                authLoading.style.display = 'none';
            }
            
            showUserMessage('Er is een kritieke fout opgetreden. Check de console voor details.', 'error');
            showLoginScreen();
        }
    });

    // Additional debugging for network issues
    window.addEventListener('online', () => {
        console.log('🌐 Network connection restored');
        updateConnectionStatus(isFirebaseConnected);
    });

    window.addEventListener('offline', () => {
        console.log('🌐 Network connection lost');
        updateConnectionStatus(false);
        showUserMessage('Internetverbinding verloren.', 'warning');
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        console.log('🚪 App shutting down');
        if (timerInterval) clearInterval(timerInterval);
        if (breathInterval) clearInterval(breathInterval);
    });

    // Add a test function for debugging
    window.testFirebase = async function() {
        console.log('🧪 Testing Firebase connection...');
        console.log('Auth object:', auth);
        console.log('Current user:', currentUser);
        console.log('Auth initialized:', authInitialized);
        console.log('Firebase connected:', isFirebaseConnected);
        
        if (auth) {
            console.log('Auth state:', auth.currentUser ? 'Logged in' : 'Not logged in');
        }
    };

    console.log('📜 Script loaded successfully - waiting for DOMContentLoaded');
</script>

</body>
</html>
